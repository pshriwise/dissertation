\section{Signed Distance Field Utilization Modeling}

In order to characterize utilization of a signed distance field as a next
surface intersection query preconditioner for ray fire calls in DAGMC, a pseudo
Monte Carlo simulation tool was developed using DAGMC. This tool was used to
simulate different transport scenarios within a spherical geometry using an
isotropic volumetric source and isotropic scattering. Particle histories are
terminated based on a maximum number of collisions or departure from the problem
geometry. Particle distance traveled, $d$, can be represented by either a fixed
distance or by sampling for the standard probability of interaction in a medium
with mean free path, $\lambda$. The tool allows the mean free path to be set
directly, enabling a relation between the signed distance field and this value
to be developed with the intent to use this relationship as a means for
characterizing appropriate conditions for application of the signed distance field.

\begin{figure}[!htb]
  \centering
  \includesvg{../images/sdf_fixed_dist_results}{0.5\textwidth}
  \caption{Results of the model for the theoretical utilization limit with the
    results of the simulation for a fixed distance traveled case.}
  \label{fig:sdf_fixed_dist}    
\end{figure}

To begin, simulations were performed for particles with a fixed distance
traveled, $\lambda$, varying that distance and the
signed distance field step sizes. Run times of the simulation are not shown here
as the data structure's utilization is the main focus of this study. The results
of this study are shown in Fig. \ref{fig:sdf_fixed_dist}. As the signed distance
field mesh step size increases, utilization of the data structure decreases due
to the increasing error associated with the interpolation of signed distance
values. Additionally, utilization is expected to decrease with increasing
distance traveled. This decreased utilization is caused by not only the increased
distance between the two particles, but also by the increased probability
that both locations will be closer to surfaces of the sphere and have smaller
signed distance values. A theoretical limit for the utilization is also shown in
Fig. \ref{fig:sdf_fixed_dist}. The development of the analytic form for this limit will now be
discussed.

\begin{figure}[ht]
  \centering
  \includesvg{../images/alpha}{0.3\textwidth}
  \caption{Depiction of model variables.}
  \label{fig:model}
\end{figure}

The utilization of the signed distance field as a preconditioner for ray tracing
operations can be modeled as an evaluation of the combined probability space for
particles with a current position, $\vec{p}$, and a next physics event location,
$\vec{n}$, after traveling a distance, $d$. The fraction of this probability
space in which signed distance values can be used to rule out surface crossings
for next surface intersections is then considered to be the theoretical
utilization of the signed distance field. An initial form for this probability
space can found in Eq. \ref{eq:util_model}.

\begin{equation}
  \label{eq:util_model}
\int_{V_{sphere}}\int_{V_{track}} p_p(r) p_n(d) \, \mathrm{d}V_{sphere}\mathrm{d}V_{track}
\end{equation}

In this model, the starting location of particles, $\vec{p}(r,\phi,\theta)$, is
uniformly distributed, $p_p(r)=1$, throughout a sphere of radius, $R$.  The
location of the next event, $n(d,\alpha,\beta)$, where $d$ is the distance
traveled by the particle, $\alpha$ is the interior angle between the
particle's \textit{position} vector and the particle's sampled direction
vector, and $\beta$ represents an azimuthal angle for directions traveled with
angle of departure $\alpha$. Fig. \ref{fig:model} depicts these
variables, $r$, $d$, and $\alpha$ more clearly.  These points are distributed
uniformly on a sphere at some distance $d$, and that distance is distributed
according to some probability density function, $p_n(d)$. 

In Eq. \ref{eq:util_model} the outer integral represents all possible particle positions within the
geometric sphere and expands to

\begin{equation}
\int_{0}^{R}\int_{0}^{2\pi}\int_{0}^{\pi}\int_{V_{track}} r^2\sin{\phi} \, \mathrm{d}\phi
\mathrm{d}\theta \mathrm{d}r \,  p_n(d) \mathrm{d}V_{track}
\end{equation}

The second integral then expands to

\begin{equation}
\small \int_{0}^{R}\int_{0}^{2\pi}\int_{0}^{\pi}\int_{0}^{\infty}\int_{0}^{2\pi}\int_{0}^{\pi}
r^2\sin{\phi} \, p_n(d) d^2 \sin{\alpha} \, \mathrm{d}\alpha \mathrm{d}\beta \mathrm{d}d \, \mathrm{d}\phi
\mathrm{d}\theta \mathrm{d}r
\end{equation}

Integration of $\phi$, $\theta$, and $\beta$ can now be performed with
the knowledge that they are symmetric with respect to the problem and
integration of $p_n(d)$ does not rely on them.

\begin{equation}
\small 8\pi^2  \int_{0}^{R}\int_{0}^{\infty}\int_{0}^{\pi} p_n(d) \,
r^2 \, d^2 \sin{\alpha} \, \mathrm{d}\alpha \mathrm{d}d \, \mathrm{d}r
\end{equation}

In order to represent particles traveling a fixed distance, the relationship in Eq. \ref{eq:pn_fixed}
is applied.

\begin{equation}
  \label{eq:pn_fixed}
  p_n(d) = \frac{\delta(d-\lambda)}{d^{2}}
\end{equation}

The evaluation of this integral then gives a representation of all the query
space available to the problem

\begin{equation}
  \label{eq:A_fixed}
\small A = 8\pi^2  \int_{0}^{R}\int_{0}^{\infty}\int_{0}^{\pi} \delta(d-\lambda) \,
r^2 \, \sin{\alpha} \, \mathrm{d}\alpha \mathrm{d}d \, \mathrm{d}r
\end{equation}

and represents all geometric query space, $A$, for a sphere of radius,
$R$ and a fixed distance traveled, $\lambda$.

In order to understand what fraction of this query space is able to be
preconditioned, the condition for avoiding an explicit nearest intersection
search along a particle direction in Eq. \ref{eq:condition} must now be
applied. Because this is intended to be an idealized upper limit for the
utilization, error will be ignored.

\begin{equation}
  SDV(\vec{p}) + SDV(\vec{n}) > |\vec{p}-\vec{n}| + 2\varepsilon(h)
  \label{eq:condition}
\end{equation}
\begin{align*}
 &SDV - \, signed \, distance \, value \, function \\
 &\vec{p} - \, particle's \, current \, position \\
 &\vec{n} - \, particle's \, next \, event \, location \\
 &h - \, mesh \, step \, size \\
 &\varepsilon(h) - \, error \, evaluation \, for \, signed \, distance \, values \\
\end{align*}

This condition establishes that the nearest location to intersection for both
points must be greater than the distance between the two points plus any error
associated with their signed distance values as previously discussed. This
condition is true for some fraction of the next surface queries in a Monte Carlo
simulation, but not all.  Our mathematical model has no error, allowing for the
largest possible volume of locations in which preconditioning will apply and the
signed distance value for any point, $\vec{x}$, is

\begin{equation}
SDV(\vec{x}) =  R-|\vec{x}|
\end{equation}

Making these substitutions into the inequality gives

\begin{equation}
R-|\vec{p}| + R - |\vec{n}| >   |\vec{p}-\vec{n}|
\end{equation}
The right hand side of this inequality can simply be described as the distance
traveled, $d$, and the magnitude of $\vec{p}$ can be represented
by the variable $r$.

\begin{equation}
 R-r + R - |n(d,\alpha,\beta)| > d
\end{equation}

Reducing the next event location, $\vec{n}(d,\alpha,\beta)$, into an expression
in terms of $r$, $d$, and $\alpha$ requires further examination of the
problem. Because the coordinates of $n$ depend on the current particle position,
the magnitude of $n$ with respect to the geometry origin must be obtained to get
a correct form for the signed distance value. Again, Fig. \ref{fig:model} depicts the
value of $n$ graphically for reference. The magnitude of n can then be described
using the law of cosines as

\begin{equation}
|n(d,\alpha,\beta)| = \sqrt{r^2 + d^2 - 2rd \cos{\pi-\alpha}}
\end{equation}
inserting this into the inequality gives

\begin{equation}
R-r + R - \sqrt{r^2 + d^2 + 2rd \cos{\alpha}} > d
\end{equation}

The inequality has now been reduced to the three variables seen in
Eq. \ref{eq:A_fixed} ($r$,$d$, and $\alpha$). This inequality can be applied to
construct limits of integration representing boundaries of space in which the
SDF can be utilized. By rearranging the inequality, a limit on the angle of
departure, $\alpha$, from the particle's position can be derived.

\begin{equation}
\alpha_{min} > \arccos\Bigg ( \frac{(2R-r-d)^2-d^2-r^2}{2 d r} \Bigg )
\end{equation}

\begin{figure*}[ht]
  \centering
  \includesvg{../images/model_cases_fixed_distance}{0.8\textwidth}
  \caption{Depiction of modeling cases.}
  \label{fig:modeling_cases}
\end{figure*}

This condition on alpha can be interpreted as a minimum interior angle that the
particle's trajectory must take relative to the particle's position vector,
$\vec{p}$, for a distance traveled, $d$, for a ray fire to be avoided and the
preconditioner to be utilized. The examination of this condition as a function
of the distance traveled for various values of $r$ results in some conclusions
about how signed distance values are being utilized.

\begin{figure}
\centering
\includesvg{../images/alpha_r}{0.5\textwidth}
\caption{Plot of minimum angle of departure restriction for particles with
various radial positions in a sphere with R = 100 cm and varying distances traveled.}
\end{figure}

The inequality is undefined until the distance reaches a value $d = R- r$. This
is because the angular limit only needs to be applied to areas of the query
space in which the distance traveled is large enough to violate the above
condition as depicted in Fig. \ref{fig:modeling_cases}. A violation of this
limit may only occur when a particle travels far enough to reach the geometric
sphere boundary along the current position vector as if it were moving directly
toward the boundary of the sphere. An additional interesting feature of this
plot is the convergence of all the curves as $d \rightarrow R$ on $\pi$. The
convergence on $\pi$ indicates that as the distance traveled approaches $R$ the
only direction that the particle can move is back toward the origin along the
position vector. It also defines a maximum distance a particle can travel in the
sphere and still be preconditioned using signed distance values. Intuitively
this makes sense as the maximum chord length of a sphere is $2R$, and once a
particle travels a distance $R$ the sum of the signed distance values can then
be no larger than $R$ and the condition for utilization in Eq. \ref{eq:condition} is
violated. Hence all curves go to zero at $\lambda = 100 cm$ in
Fig. \ref{fig:sdf_fixed_dist}.

In order to account for the fact that the form of $\alpha_{min}$ is undefined
until $d = R-r$, a Heaviside function is applied before applying it as a limit
on the particle's angle of departure from the position vector. Similarly,
because the $\alpha_{min}$ condition is undefined after $d=R$ a Heaviside
function is used to limit the condition to $\pi$ for any distances traveled
larger than $R$.

\begin{equation}
  \small
  \begin{split}
  \alpha_{min} =& (H(d-(R-r))-H(d-R)) \arccos\Bigg ( \frac{(2R-r-d)^2-d^2-r^2}{2 d r} \Bigg ) \\
  &+ \pi \, H(d-R)
  \end{split}
\end{equation}


By inserting this condition as a lower limit of the $d\alpha$ integration, the
following integral will give all utilized space, $US$, in the query space of the
simulation.

\begin{equation}
  \label{eq:subs_a_cond}
\small US = 8\pi^2  \int_{0}^{R}\int_{0}^{\infty}\int_{\boldsymbol{\alpha_{min}}}^{\pi} \delta(d-\lambda) \,
r^2 \, d^2 \sin{\alpha} \, \mathrm{d}\alpha \mathrm{d}d \, \mathrm{d}r
\end{equation}

Evaluating this integral and dividing by all query space gives the
following form for the theoretical limit of signed distance field utilization as a
preconditioner for ray firing

\begin{equation}
U_{theoretical} = \frac{US}{A} =  \frac{(1-H(\lambda-R))(2R-\lambda)(R-\lambda)}{2R^2}
\end{equation}

It can be seen in Fig. \ref{fig:sdf_fixed_dist} that this utilization limit
works well as an upper limit for the simulation results using various signed
distance field mesh resolutions. As the step size of the mesh approaches zero,
so does the evaluation of the error, resulting in the same utilization curve
with varying distance traveled, $\lambda$, as in the analytic form developed
here. Future work will include the comparison of this utilization limit to other
single-volume geometries using dimensionless parameters to determine if the
model above can be used to predict signed distance field utilization in other
geometries as well.

With the agreement of the simulation results and analytic model for signed
distance field utilization for the fixed distance traveled case, the simulation
has been used to produce a similar set of results in which the distance is
sampled based on the standard probability for distance to interaction in a
medium with a cross section, $\Sigma$, or mean free path $\lambda
=1/\Sigma$. This results in the probability distribution function shown in
Eq. \ref{eq:pn_sampled} for the particle distance traveled in this scenario.

\begin{equation}
  \label{eq:pn_sampled}
p_n(d) \propto \frac{e^{-\Sigma d}}{d^{2}} = \frac{e^{-\frac{d}{\lambda}}}{d^{2}}
\end{equation}

\begin{figure}[ht]
\centering
\includesvg{../images/sdf_sampled_dist_results}{0.5\textwidth}
\caption{Results of the model for the theoretical utilization limit with the
results of the simulation for a sampled distance traveled case.}
\label{fig:sdf_sampled_dist}
\end{figure}

%has to be in this section for latex reasons. grumble grumble...
\begin{table*}[!h]
  \centering
  \begin{tabular}{lcccc}
          \multicolumn{5}{l}{\textbf{\textit{Source Location:}} <0,0,-1>} \\
          \textbf{Implementation} & \textbf{ctme (min)} & \textbf{wall time
            (min)} & \textbf{time ratio} & \textbf{precond. utilization}\\
          \hline
          MCNP6 & 0.17 & 0.14 & 1 & N/A \\
          DAG-MCNP6 & 1841.33 & 1841.33 & ~11,000 & N/A \\
          DAG-MCNP6 w/ SDF & 0.48 & 0.46 & 2.82 & 0.94\\
          \multicolumn{5}{l}{} \\
          \multicolumn{5}{l}{\textbf{\textit{Source Location:}} <0,0,10>} \\
          \textbf{Implementation} & \textbf{ctme (min)} & \textbf{wall time
            (min)} & \textbf{time ratio} & \textbf{precond. utilization}\\
          \hline
          MCNP6 & 0.18 & 0.18 & 1 & N/A \\
          DAG-MCNP6 & 11.12 & 11.16 & 62 & N/A \\
          DAG-MCNP6 w/ SDF & 0.50 & 0.52 & 2.89 & 0.96 \\
          
  \end{tabular}
  \caption{Performance results for an MCNP6 test case involving electron
    transport of a 1 keV-100 keV photon source incident on an Fe/W target. 5,000
    histories were run in this test problem.}
  \label{tab:inp066_results}
\end{table*}

Following the same process as in the fixed distance case by plugging Eq. \ref{eq:pn_sampled} into
Eq. \ref{eq:subs_a_cond}, the utilization form for the sampled distance case is
shown in Eq. \ref{eq:sampled_limit}.

\begin{equation}
  \label{eq:sampled_limit}
  U_{theoretical} = \frac{US}{A} = \frac{ \frac{1}{2} \lambda(R - 2 \lambda) e^{\frac{-R}{\lambda}} + \lambda^2 - \frac{3}{2} R \lambda + R^2 }{R^2}
\end{equation}

The results of this set of simulations can be seen in
Fig.\ref{fig:sdf_sampled_dist}. In this scenario, it is not expected that the
utilization will approach zero when $\lambda = 100\, cm$, as the actual distance
sampled may be considerably less than the provided mean free path for the
simulation. Overall utilization values in this scenario for $\lambda$ from 0 to
100 cm remain higher than the corresponding fixed distance simulation cases as
is expected in a sampled distance case. Utilization values remain high for
relatively large increases in mesh step size, $h$. This is important to
application of the data structure given concerns regarding its potentially high
memory footprint for large volumes. For example if the utilization of the signed
distance field drops $~20\%$ when going from a step size of 1 cm to 6.21 cm, but
the memory footprint of the data structure will have decreased by a factor of
$6.21^3$ or $239.5$ as well. The optimization of the mesh step size with respect
to its effect on utilization will also need to be included in future models of
the utilization.

The fixed distance traveled scenario provides a nice baseline for agreement
between the computational results and the model, but a more realistic scenario
is required before attempting to apply the model as a predicitive utility for
application of the SDF in true Monte Carlo codes. The most useful alteration of
the current simulation scenario is to move from a fixed distance distance to a
sampled distance based on the standard probability for distance to interaction
in a medium given a cross section, $\Sigma$.

$$ p = e^{-\Sigma d} = e^{-\frac{d}{\lambda}} $$

where in this case now $\lambda$ represents the mean free path of the particle in the medium

In simulation, distances are now sampled as

$$ d = -\lambda ln(p) $$

where p is randomly sampled with a uniform distribution between 0 and 1

Inserting this definition for the particle distance into the integrals above
gives

$$ \frac{dp}{dd} = -\frac{p}{\lambda} $$
$$ d = 0 \rightarrow p = 1 $$
$$ d = D \rightarrow p = 0 $$

$$ \int_{0}^{R}\int_{0}^{2\pi}\int_{0}^{\pi}\int_{1}^{0}\int_{0}^{2\pi}\int_{0}^{\pi}
-r^2\sin{\phi} \, \lambda p ln(p)^2 \sin{\alpha} \, \mathrm{d}\alpha \mathrm{d}\beta \mathrm{d}p \, \mathrm{d}\phi
\mathrm{d}\theta \mathrm{d}r $$

This integral can then be evaluated to give the entirety of the geometry space
for the problem

\begin{center}
All Query Space = $\frac{4}{3} \lambda \pi^2 R^3$
\end{center}

To find the portion of utilized space for a given $R$ and $\lambda$ one can
apply the same methods from the fixed distance case, for each particle position
within the sphere there will still be two scenarios - one in which the distance
traveled exceeds $R-d$ and another in which it is less than $R-d$. The difference
now is d has become a distrubution rather than a constanct value, so as the
distance traveled changes the queries will fall into either category for a
single particle position.


Another way of viewing of viewing this condition in the case of a varying
distance is to define these same categories based on the distance traveled. Now
rather than defining how the angular condition is applied based on position, the
angular condition will be applied based on the distance the particle travels.


$$ d < R-r : \alpha_{min} = 0 $$
$$ d > R-r : \alpha_{min} = \arccos\Bigg ( \frac{(2R-r-d)^2-d^2-r^2}{2 d r} \Bigg
) $$

It is interesting to examine plots of the angular limit with varying distance as
seen in Fig. \label{fig:alpha_min}

\begin{figure}[ht] \label{fig:alpha_min}

\centering
\includesvg{alpha_r}{1\textwidth}
\caption{Plot of mininum angle of departure restriction for particles with
various radial positions and varying distances traveled.}
\end{figure}

The entry point of each curve in the plot represents the minimum distance
necessary to enter the $d > R-r$ region and begins to apply an agular
restriction. Note that each of these approach a mininmum angle of $\pi$ as the
distance traveled approaches $R$ (100cm). This represents a particle traveling
back towrd the origin along the sphere's larges chord with length $2R$ and,
again,the maximum distance a particle can travel before the SDF can no longer be
utilized.

Now that the distance traveled is being used to construct these two regions in
the model, this integral must be separated into two pieces, one with limits of $0$
to $R-r$ and another with limits $R-r$ to $R$. Based on the distance sampling
distribution, these values become

$$ d_{min} = R-r \rightarrow p_{max} = e^{(-\frac{(R-r)}{\lambda})} $$
$$ d_{max} = R   \rightarrow p_{min} = e^{(-\frac{R}{\lambda})} $$

and our integral becomes

$$ \int_{0}^{R}\int_{0}^{2\pi}\int_{0}^{\pi}\int_{1}^{p_{max}}\int_{0}^{2\pi}\int_{0}^{\pi}
-r^2sin(\phi) \, \lambda p ln(p)^2 sin(\alpha) \, \mathrm{d}\alpha \mathrm{d}\beta \mathrm{d}p \, \mathrm{d}\phi
\mathrm{d}\theta \mathrm{d}r + $$
$$ \int_{0}^{R}\int_{0}^{2\pi}\int_{0}^{\pi}\int_{p_{max}}^{p_{min}}\int_{0}^{2\pi}\int_{alpha_{min}}^{\pi}
-r^2\sin{\phi} \, \lambda p ln(p)^2 \sin{\alpha} \, \mathrm{d}\alpha \mathrm{d}\beta \mathrm{d}p \, \mathrm{d}\phi
\mathrm{d}\theta \mathrm{d}r $$

The evaluation of this integral divided by the full geometry query space for the
distance sampling scenario after the $c=\frac{R}{\lambda}$ replacement is

$$U(c) = \frac{1}{4}\frac{(4 c^2-6) c^2e^{-2c} - (c^3-c^2-\frac{3}{2}
c+3)4ce^{-2c}+(-2 c^3+2c^2+9c-6) e^{-2c}+4c^2-9 c+6}{c^2}$$

\begin{figure}[ht] \label{fig:sdf_sampled_dist}
\centering
\includesvg{sdf_sampled_dist_results}{\textwidth}
\caption{Results of the model for the theoretical utilization limit with the
results of the simulation for a fixed distance traveled case.}
\end{figure}

Unfortunately the predictive model for the sampled distance scenario is not
consistent with the simulation results, and under predicts the utilization of
the SDF significantly. It is quite possible that utilization in either th interior or exterior
resion of the sphere is being under represented. Regardless of the cause, examining the contribution to
utilization from each of these regions (shown in
Fig. \label{fig:util_region_contributions}) is an interesting endeavor.


\begin{figure}[ht] \label{fig:util_region_contributions}
\centering
\includesvg{../images/util_contributions}{\textwidth}
\caption{A plot of the total predicted utilization along with the contriubtions
from the inner region ($d < R-r$) and outer region ($d > R-r$).}
\end{figure}

When the mean free path $\lambda$ is very small, particles' next event locations
rarely reach the outer region condition. As $\lambda$ increases, particles are
more likely to enter that region and its contribution increases greately. Then
as particles begin to travel distances on the order of the sphere radius the
utilization decreases. The interior region utilization acts as one would
expect. When particles travel small distances with respect to the sphere radius,
there is high utilization, but as the particles begin to travel further its
utilization rapidly decreases. The contribution from the outer region defines the
significance of using both the current position signed distance value as well as the
next event location's signed distance value to precondition ray fire calls in DAGMC.
